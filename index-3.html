<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Новогоднее Бинго</title>
    <link rel="stylesheet" href="style-3.css">
</head>
<body>
    <!-- Верхнее меню -->
    <header class="header">
        <img src="orb-w-user-pick.png" alt="Profile" class="header__profile">
        <div class="header__logo">
            <img src="orb-logo-ya-360-main.png" alt="Я 360" class="header__logo-image">
        </div>
        <div class="header__menu">
            <img src="Menu_gamburger.png" alt="Menu" class="header__menu-icon">
        </div>
    </header>

    <!-- Контейнер контента -->
    <div class="container">
        <!-- Заголовок -->
        <div class="title">
            <img src="Logo.png" alt="Новогоднее Бинго" class="title__logo">
        </div>

        <!-- Обертка для прокрутки карусели -->
        <div class="cards-wrapper">
            <!-- Контейнер карточек -->
            <div class="cards-container" id="cardsContainer">
                <!-- Карточки будут добавлены через JavaScript -->
            </div>
        </div>

        <!-- Индикатор карточек -->
        <div class="cards-indicator">
            <div class="cards-indicator__track" id="cardsIndicatorTrack">
                <div class="cards-indicator__thumb" id="cardsIndicatorThumb"></div>
            </div>
        </div>
    </div>

    <!-- Индикаторы слайдера -->
    <div class="slider-indicators" id="sliderIndicators">
        <!-- Кружки будут добавлены через JavaScript -->
    </div>

    <!-- Кнопка Бинго -->
    <button class="bingo-button" id="bingoButton">
        <img src="Button_Bingo.png" alt="Бинго!" class="bingo-button__image">
    </button>

    <script>
        // Данные карточек - загружаем все 25 карточек
        const cardsData = [];
        for (let i = 1; i <= 25; i++) {
            cardsData.push({
                id: i,
                inactiveImage: `Crads_mob/Card ${i}.png`,
                activeImage: `Cards_mob_active/Card ${i}_active.png`
            });
        }

        // Состояние активных карточек
        const activeCards = new Set();

        // Кэш для предзагруженных изображений
        const imageCache = new Map();

        // Элементы индикатора карточек
        let cardsWrapperElement = null;
        let cardsIndicatorTrack = null;
        let cardsIndicatorThumb = null;

        // Функция предзагрузки изображений
        function preloadImage(src) {
            if (imageCache.has(src)) {
                return Promise.resolve(imageCache.get(src));
            }
            
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    imageCache.set(src, img);
                    resolve(img);
                };
                img.onerror = () => {
                    imageCache.set(src, null);
                    resolve(null);
                };
                img.src = src;
            });
        }

        // Предзагрузка всех изображений
        function preloadAllImages() {
            const promises = [];
            cardsData.forEach(cardData => {
                promises.push(preloadImage(cardData.inactiveImage));
                promises.push(preloadImage(cardData.activeImage));
            });
            promises.push(preloadImage("Cards_mob_active/Card 1_active.png"));
            return Promise.all(promises);
        }

        // Функция для получения пути к активной карточке
        function getActiveImagePath(cardId) {
            return `Cards_mob_active/Card ${cardId}_active.png`;
        }

        // Функция обновления изображения карточки
        function updateCardImage(cardElement, cardId, isActive) {
            const img = cardElement.querySelector('.card__image');
            if (!img) return;
            
            const imagePath = isActive ? getActiveImagePath(cardId) : cardsData[cardId - 1].inactiveImage;
            const fallbackPath = isActive ? "Cards_mob_active/Card 1_active.png" : cardsData[cardId - 1].inactiveImage;
            
            const cachedImage = imageCache.get(imagePath);
            const cachedFallback = imageCache.get(fallbackPath);
            
            if (cachedImage) {
                img.src = imagePath;
            } else if (cachedFallback) {
                img.src = fallbackPath;
            } else {
                preloadImage(imagePath).then(() => {
                    const loadedImage = imageCache.get(imagePath);
                    if (loadedImage) {
                        img.src = imagePath;
                    } else {
                        preloadImage(fallbackPath).then(() => {
                            img.src = fallbackPath;
                        });
                    }
                });
            }
        }

        // Функция создания карточки
        function createCard(cardData) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.cardId = cardData.id;
            
            const isActive = activeCards.has(cardData.id);
            const imagePath = isActive ? getActiveImagePath(cardData.id) : cardData.inactiveImage;
            const fallbackPath = isActive ? "Cards_mob_active/Card 1_active.png" : cardData.inactiveImage;

            card.innerHTML = `
                <img src="${imagePath}" alt="Card ${cardData.id}" class="card__image" 
                     onerror="if(this.src !== '${fallbackPath}') { this.src = '${fallbackPath}'; }">
            `;

            // Обработчик клика
            card.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleCard(cardData.id);
            });

            return card;
        }

        // Функция переключения состояния карточки
        function toggleCard(cardId) {
            const cardElement = document.querySelector(`[data-card-id="${cardId}"]`);
            if (!cardElement) return;
            
            if (activeCards.has(cardId)) {
                activeCards.delete(cardId);
                updateCardImage(cardElement, cardId, false);
            } else {
                activeCards.add(cardId);
                updateCardImage(cardElement, cardId, true);
            }
            
            updateBingoButtonState();
        }

        // Обновление состояния кнопки Бинго
        function updateBingoButtonState() {
            const bingoButton = document.getElementById('bingoButton');
            if (!bingoButton) return;
            
            if (activeCards.size > 0) {
                bingoButton.classList.add('bingo-button--active');
            } else {
                bingoButton.classList.remove('bingo-button--active');
            }
        }

        // Функция создания индикаторов слайдера
        function createSliderIndicators() {
            const indicatorsContainer = document.getElementById('sliderIndicators');
            indicatorsContainer.innerHTML = '';
            
            cardsData.forEach((cardData, index) => {
                const dot = document.createElement('div');
                dot.className = 'slider-indicator';
                if (index === 0) {
                    dot.classList.add('slider-indicator--active');
                }
                dot.dataset.cardIndex = index;
                indicatorsContainer.appendChild(dot);
            });
        }

        // Функция обновления активного индикатора
        function updateActiveIndicator(index) {
            const indicators = document.querySelectorAll('.slider-indicator');
            indicators.forEach((indicator, i) => {
                if (i === index) {
                    indicator.classList.add('slider-indicator--active');
                } else {
                    indicator.classList.remove('slider-indicator--active');
                }
            });
        }

        // Функция определения текущей видимой карточки
        function getCurrentCardIndex() {
            const wrapper = document.querySelector('.cards-wrapper');
            const cards = document.querySelectorAll('.card');
            const wrapperRect = wrapper.getBoundingClientRect();
            const wrapperCenter = wrapperRect.left + wrapperRect.width / 2;
            
            let closestIndex = 0;
            let closestDistance = Infinity;
            
            cards.forEach((card, index) => {
                const cardRect = card.getBoundingClientRect();
                const cardCenter = cardRect.left + cardRect.width / 2;
                const distance = Math.abs(cardCenter - wrapperCenter);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestIndex = index;
                }
            });
            
            return closestIndex;
        }

        // Функция отрисовки всех карточек
        function renderCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';

            cardsData.forEach(cardData => {
                const card = createCard(cardData);
                container.appendChild(card);
            });

            updateCardsIndicator();
        }

        // Обновление позиции индикатора карточек
        function updateCardsIndicator() {
            if (!cardsWrapperElement || !cardsIndicatorTrack || !cardsIndicatorThumb) {
                return;
            }

            const trackWidth = cardsIndicatorTrack.clientWidth;
            const scrollWidth = cardsWrapperElement.scrollWidth;
            const clientWidth = cardsWrapperElement.clientWidth;

            if (trackWidth === 0 || scrollWidth === 0) {
                return;
            }

            const maxScrollLeft = Math.max(scrollWidth - clientWidth, 0);
            const visibleRatio = scrollWidth > 0 ? clientWidth / scrollWidth : 1;
            const minThumbWidth = 24;
            const thumbWidth = Math.min(
                trackWidth,
                Math.max(trackWidth * visibleRatio, minThumbWidth)
            );

            cardsIndicatorThumb.style.width = `${thumbWidth}px`;

            if (maxScrollLeft === 0) {
                cardsIndicatorThumb.style.transform = 'translateX(0)';
                return;
            }

            const maxThumbOffset = trackWidth - thumbWidth;
            const scrollProgress = cardsWrapperElement.scrollLeft / maxScrollLeft;
            const offset = maxThumbOffset * scrollProgress;

            cardsIndicatorThumb.style.transform = `translateX(${offset}px)`;
        }

        // Инициализация индикатора карточек
        function initializeCardsIndicator() {
            cardsWrapperElement = document.querySelector('.cards-wrapper');
            cardsIndicatorTrack = document.getElementById('cardsIndicatorTrack');
            cardsIndicatorThumb = document.getElementById('cardsIndicatorThumb');

            if (!cardsWrapperElement || !cardsIndicatorTrack || !cardsIndicatorThumb) {
                return;
            }

            const handleScroll = () => {
                window.requestAnimationFrame(updateCardsIndicator);
            };

            cardsWrapperElement.addEventListener('scroll', handleScroll, { passive: true });
            window.addEventListener('resize', () => window.requestAnimationFrame(updateCardsIndicator));

            updateCardsIndicator();
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            initializeCardsIndicator();

            preloadAllImages().then(() => {
                renderCards();
                createSliderIndicators();
            });

            updateBingoButtonState();
            
            // Отслеживание прокрутки карусели
            const wrapper = document.querySelector('.cards-wrapper');
            let scrollTimeout;
            
            wrapper.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const currentIndex = getCurrentCardIndex();
                    updateActiveIndicator(currentIndex);
                }, 100);
            });
            
            document.getElementById('bingoButton').addEventListener('click', () => {
                console.log('Бинго! Активные карточки:', Array.from(activeCards));
                alert(`Выбрано карточек: ${activeCards.size}`);
            });
        });
    </script>
</body>
</html>

